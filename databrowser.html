<!DOCTYPE html>
<html>
<head>
	<meta charset="UTF-8">
	<link rel="stylesheet" type="text/css" href="style.css">
	<title>Data Browser</title>
</head>
<body>
  <fieldset>
	<br>
    <h2 class="center">⚔️🧭🗺️⚓🏴‍☠️One Piece Data Browser🏴‍☠️⚔️🧭🗺️⚓</h2>

    <div class="center">
        <button onclick="loadData()">Load Data</button><br><br>
    </div>

    <div class="container">
        <div class="form-fields">
            <div>
                <label>Name:</label>
                <input type="text" id="name" disabled><br><br>
            </div>
            <div>
                <label>Age:</label>
                <input type="text" id="age" disabled><br><br>
            </div>
            <div>
                <label>Gender:</label>
                <input type="text" id="gender" disabled><br><br>
            </div>
            <div>
                <label>Height:</label>
                <input type="text" id="height" disabled><br><br>
            </div>
            <div>
                <label>Straw Hat crew member?:</label>
                <input type="checkbox" id="strawhat" disabled>
            </div>
        </div>

        <div id="myTable" class="image-display"></div>
    </div>
	
	<br><br>
    <hr>
	<br>

    <div class="center">
        <button onclick="firstItem()">|←</button>
        <button onclick="previousItem()">←</button>
        <button onclick="nextItem()">→</button>
        <button onclick="lastItem()">→|</button>
        <div id="itemCountDisplay">(0/0)</div>
    </div>

	<br>

    <div class="spacing">
        <button id="editButton" onclick="toggleEdit()">Edit</button><br><br>
        <button onclick="showAddForm()">Insert</button><br><br>
        <button onclick="deleteCurrentItem()">Delete</button><br>
    </div>

    <div id="addItemForm" style="display:none;" class="spacing">
        <h3>Add New Item</h3>
        <div>
            <label>Name:</label>
            <input type="text" id="newName" placeholder="ex: Nami">
        </div>
		<br>
        <div>
            <label>Age:</label>
            <input type="text" id="newAge" placeholder="ex: 20">
        </div>
		<br>
        <div>
            <label>Gender:</label>
            <input type="text" id="newGender" placeholder="ex: Female">
        </div>
		<br>
        <div>
            <label>Height:</label>
            <input type="text" id="newHeight" placeholder="ex: 5'7&quot;">
        </div>
		<br>
        <div>
            <label>Image Path:</label>
            <input type="text" id="newImage" placeholder="ex: images/nami.jpg">
        </div>
		<br>
        <button onclick="saveNewItem()">Save New Item</button>
    </div>

    <div class="center">
        <button onclick="sortByDefault()">Sort by Default Order</button>
        <button onclick="sortByName()">Sort by Name</button>
    </div>

	<br>

    <div class="database-view">
        <h3>Database View</h3>
        <div id="databaseTable"></div>
    </div>

	<br>
    <h2 class="center">🏴‍☠️⚔️🧭🗺️⚓🏴‍☠️⚔️🧭🗺️⚓🏴‍☠️⚔️🧭🗺️⚓🏴‍☠️⚔️</h2>
  </fieldset>
    <script>
        let currentIndex = 0;
        let allData = [];
        let isEditing = false;

        async function loadData(sortBy = 'default') {
            try {
                const response = await fetch(`datafunctions.php?sort=${sortBy}`);
                allData = await response.json();
                
                if (allData.length > 0) {
                    currentIndex = 0;
                    displayCurrentItem();
                    updateItemCount();
                    displayDatabaseTable();
                }
            } catch (error) {
                console.error('Error loading data:', error);
            }
        }

        function displayCurrentItem() {
            if (allData.length === 0) return;
            
            const item = allData[currentIndex];
            document.getElementById('name').value = item.name;
            document.getElementById('age').value = item.age;
            document.getElementById('gender').value = item.gender;
            document.getElementById('height').value = item.height;
            
            const strawHatMembers = ['Luffy', 'Zoro', 'Nami', 'Usopp', 'Sanji', 'Chopper', 'Robin', 'Brook', 'Jinbe'];
            document.getElementById('strawhat').checked = strawHatMembers.includes(item.name);
            
            displayImage(item);
        }

        function displayImage(item) {
            const imgElement = document.createElement('img');
            imgElement.src = item.img;
            imgElement.alt = item.name;
            
            const container = document.getElementById('myTable');
            container.innerHTML = '';
            container.appendChild(imgElement);
        }

        function updateItemCount() {
            document.getElementById('itemCountDisplay').textContent = 
                `(${currentIndex + 1}/${allData.length})`;
        }

        function displayDatabaseTable() {
            const container = document.getElementById('databaseTable');
            let html = `
                <table class="database-table">
                    <thead>
                        <tr>
                            <th width="20%">Name</th>
                			<th width="20%">Age</th>
                			<th width="20%">Gender</th>
                			<th width="20%">Height</th>
                			<th width="20%">Image</th>
                        </tr>
                    </thead>
                    <tbody>
            `;
            
            allData.forEach(item => {
                html += `
                    <tr>
                        <td>${item.name}</td>
                        <td>${item.age}</td>
                        <td>${item.gender}</td>
                        <td>${item.height}</td>
						<td>${item.img}</td>
                    </tr>
                `;
            });
            
            html += '</tbody></table>';
            container.innerHTML = html;
        }

        function toggleEdit() {
            isEditing = !isEditing;
            const fields = ['name', 'age', 'gender', 'height'];
            fields.forEach(field => {
                document.getElementById(field).disabled = !isEditing;
            });
            
            const editButton = document.getElementById('editButton');
            if (isEditing) {
                editButton.textContent = 'Save';
            } else {
                editButton.textContent = 'Edit';
                saveChanges();
            }
        }

        async function saveChanges() {
            const currentItem = allData[currentIndex];
            const newData = {
                name: document.getElementById('name').value,
                age: document.getElementById('age').value,
                gender: document.getElementById('gender').value,
                height: document.getElementById('height').value,
                img: currentItem.img
            };
            
            try {
                const response = await fetch('datafunctions.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `id=${currentItem.id}&newData=${JSON.stringify(newData)}`
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    loadData();
                }
            } catch (error) {
                console.error('Error saving changes:', error);
            }
        }

        async function deleteCurrentItem() {
            if (!confirm('Are you sure you want to delete this item?')) return;
            
            const currentItem = allData[currentIndex];
            try {
                const response = await fetch('datafunctions.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `id=${currentItem.id}`
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    await loadData();
                    if (currentIndex >= allData.length) {
                        currentIndex = Math.max(0, allData.length - 1);
                    }
                    displayCurrentItem();
                }
            } catch (error) {
                console.error('Error deleting item:', error);
            }
        }

        function showAddForm() {
            document.getElementById('addItemForm').style.display = 'block';
        }

        async function saveNewItem() {
            const newItem = {
                name: document.getElementById('newName').value,
                age: document.getElementById('newAge').value,
                gender: document.getElementById('newGender').value,
                height: document.getElementById('newHeight').value,
                img: document.getElementById('newImage').value
            };
            
            try {
                const response = await fetch('datafunctions.php', {
                    method: 'POST',
                    headers: {
                        'Content-Type': 'application/x-www-form-urlencoded',
                    },
                    body: `newItem=${JSON.stringify(newItem)}`
                });
                
                const result = await response.json();
                if (result.status === 'success') {
                    document.getElementById('addItemForm').style.display = 'none';
                    clearAddForm();
                    await loadData();
                }
            } catch (error) {
                console.error('Error adding new item:', error);
            }
        }

        function clearAddForm() {
            document.getElementById('newName').value = '';
            document.getElementById('newAge').value = '';
            document.getElementById('newGender').value = '';
            document.getElementById('newHeight').value = '';
            document.getElementById('newImage').value = '';
        }

        function firstItem() {
            currentIndex = 0;
            displayCurrentItem();
            updateItemCount();
        }

        function previousItem() {
            if (currentIndex > 0) {
                currentIndex--;
                displayCurrentItem();
                updateItemCount();
            }
        }

        function nextItem() {
            if (currentIndex < allData.length - 1) {
                currentIndex++;
                displayCurrentItem();
                updateItemCount();
            }
        }

        function lastItem() {
            currentIndex = allData.length - 1;
            displayCurrentItem();
            updateItemCount();
        }

        function sortByName() {
            loadData('name');
        }

        function sortByDefault() {
            loadData('default');
        }
    </script>
</body>
</html>