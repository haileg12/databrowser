<!doctype html>
<html>
<head>
    <meta charset="utf-8" />
	<link rel="stylesheet" href="style.css">
    <title>Data Browser</title>
</head>
<body>
    <fieldset>
		<h2><span class="center">‚öîÔ∏èüß≠üó∫Ô∏è‚öìüè¥‚Äç‚ò†One Piece Data Browserüè¥‚Äç‚ò†‚öîÔ∏èüß≠üó∫Ô∏è‚öì</span></h2>
		<br>
		<label for="loadButton" style="font-weight: bold">Click Here First! ‚Üí</label>
		<button id="loadButton" onclick="makeRequest()">Load Data</button><br><br>

        <div class="container">
            <!-- Form fields on the left -->
            <div class="form-fields">
                <label for="name">Name:</label>
                <input type="text" id="name" name="name"/><br><br>

                <label for="age">Age:</label>
                <input type="text" id="age" name="age"/><br><br>
		
		        <label for="gender">Gender:</label>
		        <input type="text" id="gender" name="gender"/><br><br>
		
		        <label for="height">Height:</label>
		        <input type="text" id="height" name="height"/><br><br>
		
		        <label for="chk">Straw Hat crew member?:</label>
		        <input type="checkbox" id="chk" name="chk"/><br><br>
            </div>

            <!-- Image display on the right -->
            <div class="image-display" id="myTable">
                <!-- The image will be dynamically added here -->
            </div>
        </div>

		<br></br>
		<hr>
		<div class="center">
			<button onclick="showFirst()">|‚Üê</button>
			<button onclick="showPrevious()">‚Üê</button>
			<button onclick="showNext()">‚Üí</button>
			<button onclick="showLast()">‚Üí|</button>
			<br>
			<div id="itemCountDisplay">(0/0)</div>
		</div>
		
		<div class="spacing">
			<button onclick="edit()">Edit</span></button><br><br>
			<button onclick="insert()">Insert</span></button><br><br>
			<button onclick="deleteItem()">Delete</span></button><br><br>
			<button onclick="save()">Save</span></button><br><br>
			<button onclick="showAddItemForm()">Add New Item</button>
			<div id="addItemForm" style="display:none;">
   				<h3>Add New Item</h3>
    			<label for="newName">Name:</label>
    			<input type="text" id="newName"><br><br>
    			<label for="newAge">Age:</label>
    			<input type="text" id="newAge"><br><br>
    			<label for="newGender">Gender:</label>
    			<input type="text" id="newGender"><br><br>
    			<label for="newHeight">Height:</label>
    			<input type="text" id="newHeight"><br><br>
    			<label for="newImage">Image URL:</label>
    			<input type="text" id="newImage"><br><br>
    			<button onclick="addNewItem()">Save New Item</button>
			</div>
		</div>
		<br><br>
		<h2><span class="center">üè¥‚Äç‚ò†‚öîÔ∏èüß≠üó∫Ô∏è‚öìüè¥‚Äç‚ò†‚öîÔ∏èüß≠üó∫Ô∏è‚öìüè¥‚Äç‚ò†‚öîÔ∏èüß≠üó∫Ô∏è‚öìüè¥‚Äç‚ò†‚öîÔ∏è</span></h2>
	</fieldset>

    <script>
    let i = 0; // Tracks the current element index in the array
    let data = [];   // Stores the JSON array data after loading

    // Function to handle the request and populate the array
	function makeRequest() {
		let httpRequest = new XMLHttpRequest(); // Create the XMLHttpRequest object

		if (!httpRequest) {
			alert('Cannot create an XMLHTTP instance');
			return false;
		}

		httpRequest.onreadystatechange = function() {
			if (httpRequest.readyState === XMLHttpRequest.DONE) {
				if (httpRequest.status === 200) {
					data = JSON.parse(httpRequest.responseText); // Parse JSON data and store it in data
					i = 0; // Start at the first element
					PopulateData(data[i]); // Display the first element data
					updateItemCountDisplay();
				} else {
					alert('There was a problem with the request.');
				}
			}
		};

		httpRequest.open('GET', 'datafunctions.php'); // Make a GET request to the JSON file
		httpRequest.send(); // Send the request
	}

	/////////////////////////////////////////////////////////////////
	// Populate data function
	function PopulateData(obj) {
		document.getElementById('name').value = obj.name;
		document.getElementById('age').value = obj.age;
		document.getElementById('gender').value = obj.gender;
		document.getElementById('height').value = obj.height;
		displayImage(obj); // Display the associated image

		// Disable the form fields
		document.getElementById('name').disabled = true;
    	document.getElementById('age').disabled = true;
    	document.getElementById('gender').disabled = true;
    	document.getElementById('height').disabled = true;
	}

	/////////////////////////////////////////////////////////////////
	// Display image function
	function displayImage(obj) {
		const imgElement = document.createElement('img');
		imgElement.src = obj.img; // Use the image path from the JSON
		imgElement.alt = 'Image Loaded!';
		
		document.getElementById('myTable').innerHTML = ''; // Clear the previous content
		document.getElementById('myTable').appendChild(imgElement); // Append the new image
	}

	/////////////////////////////////////////////////////////////////
	// Navigation Functions (Next, Previous, First, Last)
	function showNext() {
		if (i < data.length - 1) {
			i++;
			PopulateData(data[i]);
			updateItemCountDisplay();
		}
	}

	function showPrevious() {
		if (i > 0) {
			i--;
			PopulateData(data[i]);
			updateItemCountDisplay();
		}
	}

	function showFirst() {
		i = 0;
		PopulateData(data[i]);
		updateItemCountDisplay();
	}

	function showLast() {
		i = data.length - 1;
		PopulateData(data[i]);
		updateItemCountDisplay();
	}

	function updateItemCountDisplay() {
    	const itemCountDisplay = document.getElementById('itemCountDisplay');
    	if (data.length === 0) {
        	itemCountDisplay.textContent = "(0/0)"; // Display (0/0) if no data
    	} else {
       		itemCountDisplay.textContent = `(${i + 1}/${data.length})`; // Display (current index + 1 / total items)
    	}
	}


	/////////////////////////////////////////////////////////////////
	// Edit function
	// Make the form fields editable
	function edit() {
    	document.getElementById('name').disabled = false;
    	document.getElementById('age').disabled = false;
    	document.getElementById('gender').disabled = false;
    	document.getElementById('height').disabled = false;
	}

	/////////////////////////////////////////////////////////////////
	// Save function
	function save() {
    	const updatedData = {
        	name: document.getElementById('name').value,
        	age: document.getElementById('age').value,
        	gender: document.getElementById('gender').value,
        	height: document.getElementById('height').value,
        	img: data[i].img // Keep the image unchanged
    	};

    	// AJAX request to send updated data to the server
    	const httpRequest = new XMLHttpRequest();
    	httpRequest.open("POST", "datafunctions.php", true);
    	httpRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    	httpRequest.onreadystatechange = function() {
        	if (httpRequest.readyState === XMLHttpRequest.DONE && httpRequest.status === 200) {
            	alert('Data saved successfully!');
            	data[i] = updatedData; // Update the local data array with the new data
            	PopulateData(data[i]); // Refresh the display with updated data
       		}
    	};

    	httpRequest.send(`id=${i}&newData=${JSON.stringify(updatedData)}`);

	}

	/////////////////////////////////////////////////////////////////
	// Delete function
	function deleteItem() {
   		if (!confirm("Are you sure you want to delete this item?")) return;

    	// AJAX request to delete data from the server
    	const httpRequest = new XMLHttpRequest();
    	httpRequest.open("POST", "datafunctions.php", true);
    	httpRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    	httpRequest.onreadystatechange = function() {
        	if (httpRequest.readyState === XMLHttpRequest.DONE && httpRequest.status === 200) {
            	const response = JSON.parse(httpRequest.responseText);
            	if (response.status === "success") {
                	alert(response.message);
                
                	// Remove item locally and update display
                	data.splice(i, 1); // Remove item from the local data array
               		i = Math.min(i, data.length - 1); // Adjust index if needed
                	PopulateData(data[i]); // Display next item or last item if array is shorter
            	} else {
                	alert("Error: " + response.message);
            	}
        	}
    	};

    	// Send the current index `i` as the `id`
    	httpRequest.send(`id=${i}`);
	}

	/////////////////////////////////////////////////////////////////
	// Add new item function
	function showAddItemForm() {
    	document.getElementById("addItemForm").style.display = "block";
	}

	function addNewItem() {
    	const newItem = {
        	name: document.getElementById("newName").value,
       		age: document.getElementById("newAge").value,
        	gender: document.getElementById("newGender").value,
        	height: document.getElementById("newHeight").value,
        	img: document.getElementById("newImage").value
    	};

    	// AJAX request to send the new item data to the server
    	const httpRequest = new XMLHttpRequest();
    	httpRequest.open("POST", "datafunctions.php", true);
    	httpRequest.setRequestHeader("Content-Type", "application/x-www-form-urlencoded");
    	httpRequest.onreadystatechange = function() {
        	if (httpRequest.readyState === XMLHttpRequest.DONE && httpRequest.status === 200) {
            	const response = JSON.parse(httpRequest.responseText);
            	if (response.status === "success") {
                	alert(response.message);
                	data.push(newItem); // Add new item to local data array
               		PopulateData(newItem); // Display the new item
                	document.getElementById("addItemForm").style.display = "none"; // Hide the form
            	} else {
                	alert("Error: " + response.message);
            	}
        	}
    	};

    	// Send new item data as JSON
    	httpRequest.send(`newItem=${JSON.stringify(newItem)}`);
	}

    </script>
</body>
</html>
